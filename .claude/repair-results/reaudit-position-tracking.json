{
  "id": "reaudit-position-tracking",
  "domain": "reaudit",
  "status": "success",
  "result": "Now I can see the critical issue. Looking at the code, I found a **major position tracking inconsistency**. Let me analyze the specific problems:\n\n## Position Tracking Accuracy Audit Report\n\n### 1. **CRITICAL ISSUE: Trade Class Incompatibility** (Lines 184-196)\nThe simulator is creating `Trade` objects with parameters that don't match the actual `Trade` class constructor from `trade.py`:\n\n**In simulator.py (Line 184-196):**\n```python\ntrade = Trade(\n    symbol=symbol,                    # NOT in Trade class constructor\n    entry_date=date,\n    entry_price=exec_price,           # NOT in Trade class constructor  \n    position_size=size,               # NOT in Trade class constructor\n    direction=direction,              # NOT in Trade class constructor\n    strategy_id=strategy_id,          # NOT in Trade class constructor\n    entry_commission=comm,            # NOT in Trade class constructor\n    entry_slippage=slippage,          # NOT in Trade class constructor\n    entry_vix=vix,                    # NOT in Trade class constructor\n    entry_regime='UNKNOWN'            # NOT in Trade class constructor\n)\n```\n\n**Actual Trade class constructor (from trade.py):**\n```python\ndef __init__(self,\n    trade_id: str,                    # REQUIRED - Missing in simulator\n    profile_name: str,                # REQUIRED - Missing in simulator\n    entry_date: datetime,\n    legs: List[TradeLeg],             # REQUIRED - Missing in simulator\n    entry_prices: Dict[int, float],   # REQUIRED - Missing in simulator\n    # ... other parameters\n)\n```\n\n### 2. **Position Updates on Fills** (Lines 184-196, 242-260)\n**Issues found:**\n- Positions are added to `self.active_trades` list (Line 196)\n- Cash is updated correctly for LONG/SHORT positions (Lines 172-179)\n- Commission is deducted (Line 181)\n- **BUT**: The Trade object created is invalid due to constructor mismatch\n\n### 3. **Reconciliation Logic** (Lines 320-350 in `_audit_step()`)\n**Good aspects:**\n- Double-entry accounting audit runs after every tick\n- Compares calculated equity vs historical equity\n- Raises SystemError if discrepancy > $0.01\n- Tracks realized P&L and fees separately\n\n**Missing reconciliation:**\n- No position-level reconciliation (only portfolio-level)\n- No validation that active_trades list matches actual positions\n- No check for duplicate positions\n\n### 4. **Partial Fills Handling** (Lines 184-196)\n**CRITICAL ISSUE: No partial fill support**\n- The `size` parameter is used as-is with `abs(size)` (Line 170)\n- No logic to handle partial order execution\n- No order splitting or fill aggregation\n- Position size is always the full requested size or nothing\n\n### 5. **Position Removal on Exit** (Lines 242-260)\n**Issues:**\n- Position removed from `active_trades` (Line 260)\n- Added to `trades` list (Line 260)\n- Realized P&L tracked (Line 255)\n- **BUT**: Uses `trade.position_size` which may not exist due to constructor mismatch\n\n### 6. **Mark-to-Market Issues** (Lines 268-295)\n**Problems:**\n- Calls `trade.calculate_pnl(mid_price, date)` (Line 276) - method may not exist\n- Uses `trade.position_size` (Line 278) - attribute may not exist\n- Uses `trade.direction` (Line 280) - attribute may not exist\n\n## **Specific Line Numbers with Issues:**\n\n1. **Line 184-196**: Invalid Trade object creation - constructor parameters don't match Trade class\n2. **Line 170**: `premium_total = exec_price * abs(size) * self.contract_multiplier` - assumes full fill\n3. **Line 196**: `self.active_trades.append(trade)` - adding potentially invalid object\n4. **Line 242**: `if trade not in self.active_trades:` - may fail due to object comparison issues\n5. **Line 248**: `comm = max(abs(trade.position_size) * self.commission_per_contract, self.min_commission)` - `position_size` may not exist\n6. **Line 251**: `premium_total = exec_price * abs(trade.position_size) * self.contract_multiplier` - `position_size` may not exist\n7. **Line 276**: `trade.calculate_pnl(mid_price, date)` - method may not exist in Trade class\n8. **Line 278**: `value = mid_price * abs(trade.position_size) * self.contract_multiplier` - `position_size` may not exist\n9. **Line 280**: `if trade.direction == 'LONG':` - `direction` may not exist\n\n## **Recommendations:**\n\n1. **Fix Trade object creation** to match actual Trade class constructor\n2. **Add partial fill support** with order splitting logic\n3. **Add position-level reconciliation** to validate active_trades\n4. **Implement position aggregation** for multiple trades on same symbol\n5. **Add fill validation** to ensure position sizes match cash impacts\n6. **Fix mark-to-market calculations** to use correct Trade class methods\n\nThe simulator appears to be using a different Trade class interface than what's actually defined in `trade.py`, which will cause runtime errors when positions are created or updated."
}