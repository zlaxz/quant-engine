{
  "id": "fix-execution-model-unify",
  "domain": "repair-quant",
  "status": "success",
  "result": "# Unified Execution Model Design Specification\n\n## 1. Overview\nThe current system has two separate execution models with inconsistent slippage calculations:\n- **`ExecutionModel`** (`execution.py`): Sophisticated spread modeling with moneyness, DTE, VIX factors, and size-based slippage\n- **`TradeSimulator._calculate_execution_price()`** (`simulator.py`): Simple VIX-based fixed-tick slippage with T+1 execution lag\n\nThis design unifies both approaches into a single, comprehensive execution model that adds partial fill logic and time-of-day spread adjustments while maintaining backward compatibility.\n\n## 2. UnifiedExecutionModel Class Design\n\n### 2.1 Core Parameters\n\n```python\nclass UnifiedExecutionModel:\n    def __init__(\n        self,\n        # Spread Configuration\n        base_spread_atm: float = 0.20,          # $0.20 ATM base spread (SPY typical)\n        base_spread_otm: float = 0.30,          # $0.30 OTM base spread\n        spread_multiplier_vol: float = 2.0,     # Max vol multiplier\n        \n        # Size-Based Slippage (percentage of half-spread)\n        slippage_small: float = 0.10,           # 1-10 contracts\n        slippage_medium: float = 0.25,          # 11-50 contracts\n        slippage_large: float = 0.50,           # 50+ contracts\n        \n        # Time-of-Day Spread Multipliers (ET market hours)\n        time_of_day_open: float = 1.5,          # 9:30-10:00 ET\n        time_of_day_midday: float = 1.0,        # 10:00-15:00 ET\n        time_of_day_close: float = 1.3,         # 15:00-16:00 ET\n        \n        # Partial Fill Configuration\n        max_volume_participation: float = 0.10, # Max 10% of daily volume\n        min_fill_probability: float = 0.3,      # Minimum fill probability\n        fill_volatility_factor: float = 1.5,    # Fill uncertainty in high vol\n        \n        # Commission & Fees\n        option_commission: float = 0.65,        # Per contract\n        min_commission: float = 1.00,           # Minimum per trade\n        es_commission: float = 2.50,            # ES futures round-trip\n        es_spread: float = 12.50,               # ES bid-ask spread\n        \n        # Regulatory Fees\n        sec_fee_rate: float = 0.00182,          # SEC fee per $1000 principal\n        occ_fee: float = 0.055,                 # OCC fee per contract\n        finra_fee: float = 0.00205,             # FINRA TAFC fee per contract (short sales)\n    ):\n```\n\n### 2.2 Spread Calculation Formula\n\n**Total Spread = Base Spread \u00d7 Moneyness Factor \u00d7 DTE Factor \u00d7 Volatility Factor \u00d7 Time-of-Day Factor \u00d7 Structure Factor**\n\n```python\ndef get_spread(\n    self,\n    mid_price: float,\n    moneyness: float,        # abs(strike - spot) / spot\n    dte: int,                # days to expiration\n    vix_level: float = 20.0,\n    is_strangle: bool = False,\n    hour_of_day: int = 12,   # 0-23, ET hour\n) -> float:\n    # Base spread (strangle tighter than straddle)\n    base = self.base_spread_otm if is_strangle else self.base_spread_atm\n    \n    # Moneyness factor: linear widening (OTM = wider)\n    moneyness_factor = 1.0 + moneyness * 5.0\n    \n    # DTE factor: wider for short-dated options\n    dte_factor = 1.0\n    if dte < 7:\n        dte_factor = 1.3     # 30% wider for weekly\n    elif dte < 14:\n        dte_factor = 1.15    # 15% wider for 2-week\n    \n    # Volatility factor: continuous scaling with VIX\n    vol_factor = 1.0 + max(0, (vix_level - 15.0) / 20.0)\n    vol_factor = min(3.0, vol_factor)\n    \n    # Time-of-day factor (ET market hours 9:30-16:00)\n    time_factor = self._get_time_of_day_factor(hour_of_day)\n    \n    # Structure factor (strangle vs straddle already in base)\n    structure_factor = 0.9 if is_strangle else 1.0\n    \n    spread = base * moneyness_factor * dte_factor * vol_factor * time_factor * structure_factor\n    return max(spread, 0.01)  # Minimum 1 cent spread\n```\n\n### 2.3 Time-of-Day Factor Calculation\n\n```python\ndef _get_time_of_day_factor(self, hour: int, minute: int = 0) -> float:\n    \"\"\"Return spread multiplier based on market microstructure patterns.\"\"\"\n    # Convert to ET market hours (9:30-16:00)\n    market_minutes = (hour - 9) * 60 + (minute - 30) if hour >= 9 else -1\n    \n    if market_minutes < 0 or market_minutes > 390:  # Outside market hours\n        return 2.0  # Much wider outside trading hours\n    \n    if market_minutes <= 30:  # 9:30-10:00 ET\n        return self.time_of_day_open\n    \n    if market_minutes >= 330:  # 15:00-16:00 ET\n        return self.time_of_day_close\n    \n    return self.time_of_day_midday  # 10:00-15:00 ET\n```\n\n### 2.4 Partial Fill Logic\n\n```python\ndef get_fill_quantity(\n    self,\n    order_size: int,          # Absolute quantity desired\n    daily_volume: int,        # Today's volume for this option\n    open_interest: int,       # Current open interest\n    vix_level: float = 20.0,\n    hour_of_day: int = 12,\n) -> Tuple[int, float]:\n    \"\"\"\n    Calculate realistic fill quantity and fill probability.\n    Returns (filled_quantity, fill_confidence).\n    \"\"\"\n    if daily_volume == 0 or open_interest < 100:\n        return 0, 0.0  # No liquidity\n    \n    # Maximum participation rate (avoid moving market)\n    max_participation = self.max_volume_participation\n    max_fill = int(daily_volume * max_participation)\n    \n    # Base fill probability based on size relative to volume\n    size_ratio = order_size / daily_volume\n    base_prob = min(1.0, 1.0 / (1.0 + size_ratio * 10))\n    \n    # Adjust for volatility (harder to fill in high vol)\n    vol_adjustment = 1.0 / (1.0 + max(0, vix_level - 20.0) / 30.0)\n    \n    # Adjust for time of day (better fills midday)\n    time_factor = self._get_time_of_day_factor(hour_of_day)\n    time_adjustment = 1.0 / time_factor  # Inverse: wider spreads = lower fill probability\n    \n    # Final fill probability\n    fill_prob = base_prob * vol_adjustment * time_adjustment\n    fill_prob = max(self.min_fill_probability, fill_prob)\n    \n    # Determine fill quantity (could be stochastic or deterministic)\n    if np.random.random() <= fill_prob:\n        # Fill up to max participation limit\n        filled = min(order_size, max_fill)\n        # Random partial fills for large orders\n        if order_size > max_fill * 2:\n            filled = max_fill * np.random.uniform(0.7, 1.0)\n        return int(filled), fill_prob\n    else:\n        return 0, fill_prob\n```\n\n### 2.5 Execution Price with Slippage\n\n```python\ndef get_execution_price(\n    self,\n    mid_price: float,\n    side: str,                # 'buy' or 'sell'\n    moneyness: float,\n    dte: int,\n    vix_level: float = 20.0,\n    is_strangle: bool = False,\n    quantity: int = 1,        # Order size (for size-based slippage)\n    filled_quantity: int = None,  # Actual fill quantity (if partial)\n    hour_of_day: int = 12,\n) -> float:\n    \"\"\"\n    Get realistic execution price including all adjustments.\n    \"\"\"\n    # Calculate base spread\n    spread = self.get_spread(mid_price, moneyness, dte, vix_level, \n                            is_strangle, hour_of_day)\n    half_spread = spread / 2.0\n    \n    # Size-based slippage (use filled quantity if partial fill)\n    qty_for_slippage = filled_quantity if filled_quantity is not None else abs(quantity)\n    abs_qty = abs(qty_for_slippage)\n    \n    if abs_qty <= 10:\n        slippage_pct = self.slippage_small\n    elif abs_qty <= 50:\n        slippage_pct = self.slippage_medium\n    else:\n        slippage_pct = self.slippage_large\n    \n    slippage = half_spread * slippage_pct\n    \n    # Directional adjustment\n    if side == 'buy':\n        return mid_price + half_spread + slippage\n    elif side == 'sell':\n        return max(0.01, mid_price - half_spread - slippage)\n    else:\n        raise ValueError(f\"Invalid side: {side}\")\n```\n\n### 2.6 Complete Execution Flow\n\n```python\ndef execute_order(\n    self,\n    mid_price: float,\n    side: str,\n    quantity: int,\n    moneyness: float,\n    dte: int,\n    daily_volume: int,\n    open_interest: int,\n    vix_level: float = 20.0,\n    is_strangle: bool = False,\n    hour_of_day: int = 12,\n    minute_of_day: int = 0,\n) -> Dict:\n    \"\"\"\n    Complete order execution simulation.\n    Returns dict with execution details.\n    \"\"\"\n    # 1. Determine fill quantity\n    filled_qty, fill_prob = self.get_fill_quantity(\n        abs(quantity), daily_volume, open_interest, \n        vix_level, hour_of_day\n    )\n    \n    if filled_qty == 0:\n        return {\n            'filled': False,\n            'filled_quantity': 0,\n            'execution_price': None,\n            'slippage': None,\n            'commission': 0.0,\n            'fill_confidence': fill_prob\n        }\n    \n    # 2. Calculate execution price\n    exec_price = self.get_execution_price(\n        mid_price, side, moneyness, dte, vix_level,\n        is_strangle, quantity, filled_qty, hour_of_day\n    )\n    \n    # 3. Calculate commission and fees\n    commission = self.get_commission_cost(filled_qty, side == 'sell', exec_price)\n    \n    # 4. Calculate total cost\n    total_cost = exec_price * filled_qty * 100 + commission\n    \n    return {\n        'filled': True,\n        'filled_quantity': filled_qty,\n        'execution_price': exec_price,\n        'slippage': abs(exec_price - mid_price),\n        'commission': commission,\n        'total_cost': total_cost,\n        'fill_confidence': fill_prob,\n        'remaining_quantity': abs(quantity) - filled_qty\n    }\n```\n\n## 3. Integration Changes\n\n### 3.1 Replace `execution.py` with Unified Model\n\n**File:** `python/engine/trading/execution.py`\n\nReplace the entire `ExecutionModel` class with `UnifiedExecutionModel`, maintaining backward compatibility by:\n1. Keeping all existing method signatures\n2. Adding new methods with default parameters\n3. Adding deprecation warnings for old usage patterns\n\n**Key changes:**\n- Add `hour_of_day` parameter to `get_spread()` and `get_execution_price()`\n- Add `get_fill_quantity()` and `execute_order()` methods\n- Update `get_commission_cost()` to include minimum commission\n\n### 3.2 Update `TradeSimulator` in `simulator.py`\n\n**File:** `python/engine/trading/simulator.py`\n\nReplace `_calculate_execution_price()` with calls to `UnifiedExecutionModel`:\n\n```python\n# In __init__():\nself.execution_model = UnifiedExecutionModel()\n\n# Replace _calculate_execution_price() with:\ndef _calculate_execution_price(self, mid_price: float, direction: str, \n                               action: str, vix: float = 20.0,\n                               moneyness: float = 0.0, dte: int = 30,\n                               quantity: int = 1, hour_of_day: int = 12) -> Tuple[float, float]:\n    side = 'buy' if (action == 'ENTRY' and direction == 'LONG') or \\\n                    (action == 'EXIT' and direction == 'SHORT') else 'sell'\n    \n    exec_price = self.execution_model.get_execution_price(\n        mid_price=mid_price,\n        side=side,\n        moneyness=moneyness,\n        dte=dte,\n        vix_level=vix,\n        quantity=quantity,\n        hour_of_day=hour_of_day\n    )\n    \n    slippage = abs(exec_price - mid_price)\n    return exec_price, slippage\n```\n\n**Update `enter_trade()` and `exit_trade()` methods** to pass additional parameters:\n- Calculate `moneyness` from strike and spot price\n- Extract `dte` from trade legs\n- Get `hour_of_day` from execution timestamp\n\n### 3.3 Update `PolygonOptionsLoader` in `polygon_options.py`\n\n**File:** `python/engine/data/polygon_options.py`\n\nUpdate spread calculation to include time-of-day factor:\n\n```python\n# In load_day() method, update spread calculation:\ndf['spread_dollars'] = df.apply(\n    lambda row: self.execution_model.get_spread(\n        mid_price=row['mid'],\n        moneyness=row['moneyness'],\n        dte=row['dte'],\n        vix_level=vix_level,\n        is_strangle=False,\n        hour_of_day=14  # Assume midday for daily bars\n    ),\n    axis=1\n)\n```\n\n## 4. Configuration Parameters\n\n### 4.1 Default Values (SPY Options)\n\n| Parameter | Value | Description |\n|-----------|-------|-------------|\n| `base_spread_atm` | $0.20 | ATM straddle spread |\n| `base_spread_otm` | $0.30 | OTM option spread |\n| `slippage_small` | 0.10 | 10% of half-spread for \u226410 contracts |\n| `slippage_medium` | 0.25 | 25% of half-spread for 11-50 contracts |\n| `slippage_large` | 0.50 | 50% of half-spread"
}