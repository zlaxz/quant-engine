{
  "id": "fix-react-cleanup-activityfeed",
  "domain": "repair-react",
  "status": "success",
  "result": "Now I have a complete understanding of the code. Let me analyze the ActivityFeed.tsx file for memory leaks:\n\n## Memory Leak Analysis for ActivityFeed.tsx\n\nBased on my examination, I found **3 critical memory leak issues**:\n\n### Issue 1: Missing cleanup function for `onDaemonLog` event listener (Lines 136-149)\nThe `useEffect` that sets up the daemon log listener returns the unsubscribe function, but there's a problem: it doesn't check if `window.electron` exists before calling the cleanup function.\n\n### Issue 2: Missing dependency array in auto-scroll effect (Lines 151-157)\nThe auto-scroll `useEffect` is missing a dependency array, causing it to run on every render.\n\n### Issue 3: Missing cleanup for `processedLogs` ref (Potential issue)\nThe `processedLogs` ref accumulates logs indefinitely without cleanup.\n\n## Exact Code Changes Needed:\n\n### Change 1: Fix the daemon log listener cleanup\n\n**Lines 136-149** - Replace with:\n\n```typescript\n// Listen to daemon logs\nuseEffect(() => {\n  if (!window.electron?.onDaemonLog) return;\n\n  const unsubscribe = window.electron.onDaemonLog((log) => {\n    // Deduplicate logs\n    if (processedLogs.current.has(log)) return;\n    processedLogs.current.add(log);\n\n    const event = parseLogToEvent(log, processedLogs.current.size);\n    if (event) {\n      setEvents((prev) => [...prev.slice(-99), event]); // Keep last 100 events\n    }\n  });\n\n  return () => {\n    if (unsubscribe) unsubscribe();\n  };\n}, []);\n```\n\n### Change 2: Add proper dependency array to auto-scroll effect\n\n**Lines 151-157** - Replace with:\n\n```typescript\n// Auto-scroll to bottom when new events arrive\nuseEffect(() => {\n  if (isLive && scrollRef.current) {\n    scrollRef.current.scrollTop = scrollRef.current.scrollHeight;\n  }\n}, [events, isLive]);\n```\n\n### Change 3: Add cleanup for processed logs on component unmount\n\nAdd this new `useEffect` after the existing ones:\n\n```typescript\n// Cleanup processed logs on unmount\nuseEffect(() => {\n  return () => {\n    processedLogs.current.clear();\n  };\n}, []);\n```\n\n### Change 4: Add null check for window.electron in initial logs effect\n\n**Lines 159-177** - Update the beginning of the effect:\n\n```typescript\n// Load initial events from daemon status\nuseEffect(() => {\n  const loadInitialLogs = async () => {\n    if (!window.electron?.getDaemonLogs) return;\n\n    try {\n      const logs = await window.electron.getDaemonLogs();\n      const initialEvents = logs\n        .slice(-20) // Last 20 logs\n        .map((log, i) => parseLogToEvent(log, i))\n        .filter((e): e is ActivityEvent => e !== null);\n\n      setEvents(initialEvents);\n      logs.forEach(log => processedLogs.current.add(log));\n    } catch (error) {\n      console.error('Failed to load daemon logs:', error);\n    }\n  };\n\n  loadInitialLogs();\n}, []);\n```\n\n## Summary of Memory Leak Fixes:\n\n1. **Fixed event listener cleanup**: Added proper cleanup function that calls the unsubscribe function returned by `onDaemonLog`\n2. **Fixed missing dependency array**: Added `[events, isLive]` to auto-scroll effect to prevent unnecessary re-renders\n3. **Added cleanup for processed logs**: Clears the `Set` on component unmount to prevent memory accumulation\n4. **Added null safety**: Ensured all `window.electron` calls have proper null checks\n\nThese changes ensure that:\n- Event listeners are properly cleaned up when the component unmounts\n- No memory leaks from accumulating logs in the `processedLogs` Set\n- Effects only run when their dependencies change\n- All Electron API calls are safe even if `window.electron` is undefined"
}