{
  "id": "fix-ipc-cleanup",
  "domain": "repair-ipc",
  "status": "success",
  "result": "Now I have a good understanding of the codebase. Let me analyze the `memoryHandlers.ts` file for memory leak issues:\n\n## Analysis of IPC Event Listener Cleanup Issues\n\nBased on my examination of `src/electron/ipc-handlers/memoryHandlers.ts`, I found several issues:\n\n### 1. **Event Listeners Registered Without Cleanup**\nThe file registers multiple `ipcMain.handle()` calls but never removes them. These handlers persist across the entire application lifecycle and could cause issues if the module is reloaded or if handlers need to be updated.\n\n### 2. **MemoryDaemon Event Listeners with Partial Cleanup**\nLines 125-150 show event listeners being registered on `memoryDaemon` with cleanup logic, but this only happens when `registerMemoryHandlers()` is called. There's no global cleanup function to remove these listeners when the app shuts down.\n\n### 3. **Missing Global Cleanup Function**\nThere's no exported function to clean up all registered IPC handlers and event listeners.\n\n### 4. **Potential Double Registration**\nIf `registerMemoryHandlers()` is called multiple times (which shouldn't happen but could in development), the `ipcMain.handle()` calls would be duplicated since Electron doesn't prevent duplicate handler registration.\n\n## Code Changes Needed\n\nHere are the exact changes to add proper cleanup patterns:\n\n### Change 1: Add cleanup function at the end of memoryHandlers.ts\n\n```typescript\n// Add this function at the end of the file, before the closing brace\n\n/**\n * Clean up all IPC handlers and event listeners\n * Call this when the app is shutting down or when handlers need to be refreshed\n */\nexport function cleanupMemoryHandlers(): void {\n  // Remove all ipcMain handlers registered by this module\n  ipcMain.removeHandler('memory:recall');\n  ipcMain.removeHandler('memory:formatForPrompt');\n  ipcMain.removeHandler('memory:warmCache');\n  ipcMain.removeHandler('memory:daemon:start');\n  ipcMain.removeHandler('memory:daemon:stop');\n  ipcMain.removeHandler('memory:daemon:status');\n  \n  // Remove analysis handlers if they were registered\n  ipcMain.removeHandler('analysis:check-overfitting');\n  ipcMain.removeHandler('analysis:get-warnings');\n  ipcMain.removeHandler('memory:get-stale');\n  ipcMain.removeHandler('memory:check-triggers');\n  ipcMain.removeHandler('analysis:detect-patterns');\n  ipcMain.removeHandler('analysis:tag-regime');\n  ipcMain.removeHandler('memory:mark-recalled');\n  \n  // Clean up MemoryDaemon event listeners\n  if (memoryDaemon && extractionListener) {\n    memoryDaemon.off('memories-extracted', extractionListener);\n    extractionListener = null;\n  }\n  \n  if (memoryDaemon && errorListener) {\n    memoryDaemon.off('error', errorListener);\n    errorListener = null;\n  }\n  \n  // Reset service references\n  memoryDaemon = null;\n  recallEngine = null;\n  \n  console.log('[MemoryHandlers] Cleaned up all handlers and listeners');\n}\n```\n\n### Change 2: Update registerMemoryHandlers() to prevent duplicate registration\n\n```typescript\n// Add a flag at the top of the file with other declarations\nlet handlersRegistered = false;\n\nexport function registerMemoryHandlers(): void {\n  // Prevent duplicate registration\n  if (handlersRegistered) {\n    console.warn('[MemoryHandlers] Handlers already registered, skipping');\n    return;\n  }\n  \n  // ... existing handler registrations ...\n  \n  handlersRegistered = true;\n}\n```\n\n### Change 3: Update cleanupMemoryHandlers() to reset the registration flag\n\n```typescript\nexport function cleanupMemoryHandlers(): void {\n  // ... existing cleanup code ...\n  \n  // Reset registration flag\n  handlersRegistered = false;\n  \n  console.log('[MemoryHandlers] Cleaned up all handlers and listeners');\n}\n```\n\n### Change 4: Update main.ts to call cleanup on app shutdown\n\nIn `src/electron/main.ts`, update the `before-quit` handler:\n\n```typescript\napp.on('before-quit', async () => {\n  // Close all pop-out windows first\n  closeAllPopouts();\n\n  // Stop research daemon (Night Shift)\n  stopDaemonOnExit();\n\n  // Clean up memory handlers\n  cleanupMemoryHandlers(); // ADD THIS LINE\n  \n  // Stop memory daemon gracefully\n  if (memoryDaemon) {\n    await memoryDaemon.stop();\n  }\n  if (localDb) {\n    localDb.close();\n  }\n});\n```\n\n### Change 5: Add import for cleanup function in main.ts\n\n```typescript\n// Update the import statement in main.ts\nimport { \n  registerMemoryHandlers, \n  setMemoryServices, \n  registerAnalysisHandlers,\n  cleanupMemoryHandlers  // ADD THIS\n} from './ipc-handlers/memoryHandlers';\n```\n\n## Summary of Changes\n\n1. **Added `cleanupMemoryHandlers()` function** that:\n   - Removes all IPC handlers using `ipcMain.removeHandler()`\n   - Cleans up MemoryDaemon event listeners\n   - Resets service references to null\n   - Resets registration flag\n\n2. **Added duplicate registration prevention** with `handlersRegistered` flag\n\n3. **Integrated cleanup into app shutdown** in `main.ts`\n\n4. **Properly exported cleanup function** for use in main process\n\nThese changes ensure that:\n- IPC handlers are properly cleaned up on app shutdown\n- Event listeners don't leak memory\n- Duplicate handler registration is prevented\n- The code follows consistent cleanup patterns similar to other parts of the codebase (like `stopDaemonOnExit()` in daemonManager.ts)"
}